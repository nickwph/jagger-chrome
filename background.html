<script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>

<script>

//__DEBUG__//
var debug = {
	mode: true,
	log: function(string) { 
		if (this.mode) console.log("B: "+string); 
	}
}

//__ONLOAD__//
debug.log("Debug Mode");

//__INJECT__//
function inject(detail) {
	if (detail.save) storage.save(detail);
	javascript.run(detail);
	debug.log("Injected.");
}

//__STORAGE__//
var storage = {
	save: function(detail) {
		var id = this.contain(detail.url); //check existance
		if (id == -1) id = localStorage.length; //override the old save
		detail.id = id;
		localStorage[id] = JSON.stringify(detail);
		return id;
	},
	get: function(id) {
		return JSON.parse(localStorage[id]);
	},
	remove: function(id) {
		localStorage.removeItem(id);
	},
	length: function() {
		return localStorage.length;
	},
	contain: function(url) {
		for (var i=0; i<this.length(); i++) {
			if (url.match(this.get(i).url)) {
				return i;
			}
		}
		return -1;
	}
}

//__FUNCTIONS__//
var javascript = {
	execute: function(script) {
		chrome.windows.getCurrent(function(window) {
			chrome.tabs.getSelected(window.id, function(tab){
				chrome.tabs.executeScript(tab.id, {code:script});
			});
		});
	},
	insert: function(file) {
		chrome.windows.getCurrent(function(window) {
			chrome.tabs.getSelected(window.id, function(tab){
				chrome.tabs.executeScript(tab.id, {file:file});
			});
		});
	},
	run: function(packet) {
		for (i in packet.include) {
			this.insert(packet.include[i]);
		}
		this.execute(packet.script);
	}
}

//__LISTENERS__//
chrome.tabs.onUpdated.addListener(function(tabId, info, tab) {
	if (info.status == "complete") { //run when the page finished loading, otherwise it fires twice
		var id = storage.contain(tab.url);
		if (id != -1 && storage.get(id).autorun) {
			javascript.run(storage.get(id));
			debug.log("Existing script executed.");
		}
	}
});
	
</script>